

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Lesson 42: Control panels &mdash; Programming Bootcamp  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "document", "processHtmlClass": "math|output_area"}}</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lesson 14: Testing and test-driven development" href="l14_testing_and_tdd.html" />
    <link rel="prev" title="Lesson 41. Apps for controlling external devices" href="l41_serial_apps.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #F1F2D8" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Lessons</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="l00_configuring_your_computer.html">Lesson 0: Configuring your computer</a></li>
<li class="toctree-l1"><a class="reference internal" href="l01_welcome.html">Lesson 1: Welcome and Introduction to JupyterLab</a></li>
<li class="toctree-l1"><a class="reference internal" href="l02_basic_command_line_skills.html">Lesson 2: Basic command line skills</a></li>
<li class="toctree-l1"><a class="reference internal" href="l03_variables_operators_types.html">Lesson 3: Variables, operators, and types</a></li>
<li class="toctree-l1"><a class="reference internal" href="l04_more_operators_and_conditionals.html">Lesson 4: More operators and conditionals</a></li>
<li class="toctree-l1"><a class="reference internal" href="l05_lists_and_tuples.html">Lesson 5: Lists and tuples</a></li>
<li class="toctree-l1"><a class="reference internal" href="l06_iteration.html">Lesson 6: Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="l07_intro_to_functions.html">Lesson 7: Introduction to functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="l08_string_methods.html">Lesson 8: String methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="l09_dictionaries.html">Lesson 9: Dictionaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="l10_packages_and_modules.html">Lesson 10: Packages and modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="l11_file_io.html">Lesson 11: File I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="l12_version_control_with_git.html">Lesson 12: Version control with Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="l13_exceptions_and_error_handling.html">Lesson 13: Errors and Exception handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="l16_style.html">Lesson 16: Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="l17_intro_to_pandas.html">Lesson 17: Introduction to Pandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="l18_split_apply_combine.html">Lesson 18: Tidy data and split-apply-combine</a></li>
<li class="toctree-l1"><a class="reference internal" href="l19_plotting.html">Lesson 19: Making plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="l20_high_level_plotting.html">Lesson 20: High level plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="l21_intro_to_numpy_and_scipy.html">Lesson 21: Introduction to Numpy and Scipy</a></li>
<li class="toctree-l1"><a class="reference internal" href="l22_plotting_time_series_generated_data.html">Lesson 22: Plotting time series and generated data</a></li>
<li class="toctree-l1"><a class="reference internal" href="l23_random_number_generation.html">Lesson 23: Random number generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="l24_comprehensions.html">Lesson 24: Comprehensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="l25_hackerstats_1.html">Lesson 25: Hacker stats I</a></li>
<li class="toctree-l1"><a class="reference internal" href="l26_hackerstats_2.html">Lesson 26: Hacker stats II</a></li>
<li class="toctree-l1"><a class="reference internal" href="l27_holoviews.html">Lesson 27: High level plotting with HoloViews</a></li>
<li class="toctree-l1"><a class="reference internal" href="l28_overplotting.html">Lesson 28: Dealing with overplotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="l38_intro_to_image_processing.html">Lesson 38: Introduction to image processing with scikit-image</a></li>
<li class="toctree-l1"><a class="reference internal" href="l39_segmentation.html">Lesson 39: Basic image quantification</a></li>
<li class="toctree-l1"><a class="reference internal" href="l32_other_packages_and_languages.html">Lesson 32: Survey of other packages and languages</a></li>
<li class="toctree-l1"><a class="reference internal" href="l33_bootcamp_recap.html">Lesson 33: Bootcamp recap</a></li>
</ul>
<p class="caption"><span class="caption-text">Auxiliary lessons</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="l30_javascript_for_bokeh.html">Lesson 30: JavaScript for stand-alone Bokeh apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="l31_intro_to_scripting.html">Lesson 31: Introduction to scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="l34_more_command_line.html">Lesson 34: More about the command line</a></li>
<li class="toctree-l1"><a class="reference internal" href="l35_regular_expressions.html">Lesson 35: Regular expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="l36_intro_to_oop.html">Lesson 36: Introduction to object-oriented programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="l37_algorithmic_complexity.html">Lesson 37: Algorithmic complexity</a></li>
<li class="toctree-l1"><a class="reference internal" href="l40_serial.html">Lesson 40: Control of external devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="l41_serial_apps.html">Lesson 41. Apps for controlling external devices</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lesson 42: Control panels</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Sketching-a-dashboard">Sketching a dashboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Connecting-to-Arduino-and-opening-DAQ">Connecting to Arduino and opening DAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Building-the-app">Building the app</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Aside:-error-checking">Aside: error checking</a></li>
<li class="toctree-l2"><a class="reference internal" href="#A-stand-alone-app">A stand-alone app</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Computing-environment">Computing environment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="l14_testing_and_tdd.html">Lesson 14: Testing and test-driven development</a></li>
<li class="toctree-l1"><a class="reference internal" href="l15_examples_of_tdd.html">Lesson 15: Examples of TDD</a></li>
<li class="toctree-l1"><a class="reference internal" href="l29_dashboards.html">Lesson 29: Dashboards</a></li>
</ul>
<p class="caption"><span class="caption-text">Exercises</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../exercises/exercise_1/index.html">Exercise 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/exercise_2/index.html">Exercise 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/exercise_3/index.html">Exercise 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/exercise_4/index.html">Exercise 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/exercise_5/index.html">Exercise 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/exercise_6/index.html">Exercise 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/exercise_7/index.html">Exercise 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/exercise_8/index.html">Exercise 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/exercise_9/index.html">Exercise 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/exercise_10/index.html">Exercise 10</a></li>
</ul>
<p class="caption"><span class="caption-text">Schedule</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../schedule.html">Schedule overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schedule.html#daily-schedule">Daily schedule</a></li>
</ul>
<p class="caption"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Scientific Python distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html#online-instruction">Online instruction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html#books">Books</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html#griffin-chure-s-templates-for-reproducible-publishing">Griffin Chure’s templates for reproducible publishing</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Programming Bootcamp</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Lesson 42: Control panels</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/lessons/l42_control_panels.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Lesson-42:-Control-panels">
<h1>Lesson 42: Control panels<a class="headerlink" href="#Lesson-42:-Control-panels" title="Permalink to this headline">¶</a></h1>
<hr><div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">import</span> <span class="nn">serial.tools.list_ports</span>

<span class="kn">import</span> <span class="nn">bokeh.plotting</span>
<span class="kn">import</span> <span class="nn">bokeh.io</span>
<span class="kn">import</span> <span class="nn">bokeh.layouts</span>
<span class="kn">import</span> <span class="nn">bokeh.driving</span>
<span class="n">bokeh</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">output_notebook</span><span class="p">()</span>

<span class="n">notebook_url</span> <span class="o">=</span> <span class="s2">&quot;localhost:8888&quot;</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div class="bk-root">
    <a href="https://bokeh.org" target="_blank" class="bk-logo bk-logo-small bk-logo-notebook"></a>
    <span id="1002">Loading BokehJS ...</span>
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="output_javascript"></div>
<script type="text/javascript">
var element = document.currentScript.previousSibling.previousSibling;

(function(root) {
  function now() {
    return new Date();
  }

  var force = true;

  if (typeof root._bokeh_onload_callbacks === "undefined" || force === true) {
    root._bokeh_onload_callbacks = [];
    root._bokeh_is_loading = undefined;
  }

  var JS_MIME_TYPE = 'application/javascript';
  var HTML_MIME_TYPE = 'text/html';
  var EXEC_MIME_TYPE = 'application/vnd.bokehjs_exec.v0+json';
  var CLASS_NAME = 'output_bokeh rendered_html';

  /**
   * Render data to the DOM node
   */
  function render(props, node) {
    var script = document.createElement("script");
    node.appendChild(script);
  }

  /**
   * Handle when an output is cleared or removed
   */
  function handleClearOutput(event, handle) {
    var cell = handle.cell;

    var id = cell.output_area._bokeh_element_id;
    var server_id = cell.output_area._bokeh_server_id;
    // Clean up Bokeh references
    if (id != null && id in Bokeh.index) {
      Bokeh.index[id].model.document.clear();
      delete Bokeh.index[id];
    }

    if (server_id !== undefined) {
      // Clean up Bokeh references
      var cmd = "from bokeh.io.state import curstate; print(curstate().uuid_to_server['" + server_id + "'].get_sessions()[0].document.roots[0]._id)";
      cell.notebook.kernel.execute(cmd, {
        iopub: {
          output: function(msg) {
            var id = msg.content.text.trim();
            if (id in Bokeh.index) {
              Bokeh.index[id].model.document.clear();
              delete Bokeh.index[id];
            }
          }
        }
      });
      // Destroy server and session
      var cmd = "import bokeh.io.notebook as ion; ion.destroy_server('" + server_id + "')";
      cell.notebook.kernel.execute(cmd);
    }
  }

  /**
   * Handle when a new output is added
   */
  function handleAddOutput(event, handle) {
    var output_area = handle.output_area;
    var output = handle.output;

    // limit handleAddOutput to display_data with EXEC_MIME_TYPE content only
    if ((output.output_type != "display_data") || (!Object.prototype.hasOwnProperty.call(output.data, EXEC_MIME_TYPE))) {
      return
    }

    var toinsert = output_area.element.find("." + CLASS_NAME.split(' ')[0]);

    if (output.metadata[EXEC_MIME_TYPE]["id"] !== undefined) {
      toinsert[toinsert.length - 1].firstChild.textContent = output.data[JS_MIME_TYPE];
      // store reference to embed id on output_area
      output_area._bokeh_element_id = output.metadata[EXEC_MIME_TYPE]["id"];
    }
    if (output.metadata[EXEC_MIME_TYPE]["server_id"] !== undefined) {
      var bk_div = document.createElement("div");
      bk_div.innerHTML = output.data[HTML_MIME_TYPE];
      var script_attrs = bk_div.children[0].attributes;
      for (var i = 0; i < script_attrs.length; i++) {
        toinsert[toinsert.length - 1].firstChild.setAttribute(script_attrs[i].name, script_attrs[i].value);
        toinsert[toinsert.length - 1].firstChild.textContent = bk_div.children[0].textContent
      }
      // store reference to server id on output_area
      output_area._bokeh_server_id = output.metadata[EXEC_MIME_TYPE]["server_id"];
    }
  }

  function register_renderer(events, OutputArea) {

    function append_mime(data, metadata, element) {
      // create a DOM node to render to
      var toinsert = this.create_output_subarea(
        metadata,
        CLASS_NAME,
        EXEC_MIME_TYPE
      );
      this.keyboard_manager.register_events(toinsert);
      // Render to node
      var props = {data: data, metadata: metadata[EXEC_MIME_TYPE]};
      render(props, toinsert[toinsert.length - 1]);
      element.append(toinsert);
      return toinsert
    }

    /* Handle when an output is cleared or removed */
    events.on('clear_output.CodeCell', handleClearOutput);
    events.on('delete.Cell', handleClearOutput);

    /* Handle when a new output is added */
    events.on('output_added.OutputArea', handleAddOutput);

    /**
     * Register the mime type and append_mime function with output_area
     */
    OutputArea.prototype.register_mime_type(EXEC_MIME_TYPE, append_mime, {
      /* Is output safe? */
      safe: true,
      /* Index of renderer in `output_area.display_order` */
      index: 0
    });
  }

  // register the mime type if in Jupyter Notebook environment and previously unregistered
  if (root.Jupyter !== undefined) {
    var events = require('base/js/events');
    var OutputArea = require('notebook/js/outputarea').OutputArea;

    if (OutputArea.prototype.mime_types().indexOf(EXEC_MIME_TYPE) == -1) {
      register_renderer(events, OutputArea);
    }
  }


  if (typeof (root._bokeh_timeout) === "undefined" || force === true) {
    root._bokeh_timeout = Date.now() + 5000;
    root._bokeh_failed_load = false;
  }

  var NB_LOAD_WARNING = {'data': {'text/html':
     "<div style='background-color: #fdd'>\n"+
     "<p>\n"+
     "BokehJS does not appear to have successfully loaded. If loading BokehJS from CDN, this \n"+
     "may be due to a slow or bad network connection. Possible fixes:\n"+
     "</p>\n"+
     "<ul>\n"+
     "<li>re-rerun `output_notebook()` to attempt to load from CDN again, or</li>\n"+
     "<li>use INLINE resources instead, as so:</li>\n"+
     "</ul>\n"+
     "<code>\n"+
     "from bokeh.resources import INLINE\n"+
     "output_notebook(resources=INLINE)\n"+
     "</code>\n"+
     "</div>"}};

  function display_loaded() {
    var el = document.getElementById("1002");
    if (el != null) {
      el.textContent = "BokehJS is loading...";
    }
    if (root.Bokeh !== undefined) {
      if (el != null) {
        el.textContent = "BokehJS " + root.Bokeh.version + " successfully loaded.";
      }
    } else if (Date.now() < root._bokeh_timeout) {
      setTimeout(display_loaded, 100)
    }
  }


  function run_callbacks() {
    try {
      root._bokeh_onload_callbacks.forEach(function(callback) {
        if (callback != null)
          callback();
      });
    } finally {
      delete root._bokeh_onload_callbacks
    }
    console.debug("Bokeh: all callbacks have finished");
  }

  function load_libs(css_urls, js_urls, callback) {
    if (css_urls == null) css_urls = [];
    if (js_urls == null) js_urls = [];

    root._bokeh_onload_callbacks.push(callback);
    if (root._bokeh_is_loading > 0) {
      console.debug("Bokeh: BokehJS is being loaded, scheduling callback at", now());
      return null;
    }
    if (js_urls == null || js_urls.length === 0) {
      run_callbacks();
      return null;
    }
    console.debug("Bokeh: BokehJS not loaded, scheduling load and callback at", now());
    root._bokeh_is_loading = css_urls.length + js_urls.length;

    function on_load() {
      root._bokeh_is_loading--;
      if (root._bokeh_is_loading === 0) {
        console.debug("Bokeh: all BokehJS libraries/stylesheets loaded");
        run_callbacks()
      }
    }

    function on_error(url) {
      console.error("failed to load " + url);
    }

    for (let i = 0; i < css_urls.length; i++) {
      const url = css_urls[i];
      const element = document.createElement("link");
      element.onload = on_load;
      element.onerror = on_error.bind(null, url);
      element.rel = "stylesheet";
      element.type = "text/css";
      element.href = url;
      console.debug("Bokeh: injecting link tag for BokehJS stylesheet: ", url);
      document.body.appendChild(element);
    }

    const hashes = {"https://cdn.bokeh.org/bokeh/release/bokeh-2.3.2.min.js": "XypntL49z55iwGVUW4qsEu83zKL3XEcz0MjuGOQ9SlaaQ68X/g+k1FcioZi7oQAc", "https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.3.2.min.js": "bEsM86IHGDTLCS0Zod8a8WM6Y4+lafAL/eSiyQcuPzinmWNgNO2/olUF0Z2Dkn5i", "https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.3.2.min.js": "TX0gSQTdXTTeScqxj6PVQxTiRW8DOoGVwinyi1D3kxv7wuxQ02XkOxv0xwiypcAH"};

    for (let i = 0; i < js_urls.length; i++) {
      const url = js_urls[i];
      const element = document.createElement('script');
      element.onload = on_load;
      element.onerror = on_error.bind(null, url);
      element.async = false;
      element.src = url;
      if (url in hashes) {
        element.crossOrigin = "anonymous";
        element.integrity = "sha384-" + hashes[url];
      }
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      document.head.appendChild(element);
    }
  };

  function inject_raw_css(css) {
    const element = document.createElement("style");
    element.appendChild(document.createTextNode(css));
    document.body.appendChild(element);
  }


  var js_urls = ["https://cdn.bokeh.org/bokeh/release/bokeh-2.3.2.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.3.2.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.3.2.min.js"];
  var css_urls = [];


  var inline_js = [
    function(Bokeh) {
      Bokeh.set_log_level("info");
    },
    function(Bokeh) {


    }
  ];

  function run_inline_js() {

    if (root.Bokeh !== undefined || force === true) {

    for (var i = 0; i < inline_js.length; i++) {
      inline_js[i].call(root, root.Bokeh);
    }
    if (force === true) {
        display_loaded();
      }} else if (Date.now() < root._bokeh_timeout) {
      setTimeout(run_inline_js, 100);
    } else if (!root._bokeh_failed_load) {
      console.log("Bokeh: BokehJS failed to load within specified timeout.");
      root._bokeh_failed_load = true;
    } else if (force !== true) {
      var cell = $(document.getElementById("1002")).parents('.cell').data().cell;
      cell.output_area.append_execute_result(NB_LOAD_WARNING)
    }

  }

  if (root._bokeh_is_loading === 0) {
    console.debug("Bokeh: BokehJS loaded, going straight to plotting");
    run_inline_js();
  } else {
    load_libs(css_urls, js_urls, function() {
      console.debug("Bokeh: BokehJS plotting callback run at", now());
      run_inline_js();
    });
  }
}(window));
</script></div>
</div>
<hr><p>We have seen how to create buttons for controlling data acquisition, how to asynchronously acquire streaming data, and how to have automatically updating plots. Taken together, you now have the tools to build a <em>control panel</em> for a device. When building a device, it is important to have intuitive controls and displays to get the most out of your device. Not only does this speed up your work, it also enables other researchers to easily use your device.</p>
<p>You are of course thoughtful about the physical design of any device you make. There’s no option; it won’t work if you don’t build it well. At the same time, you should also be thoughtful about how you <em>interface</em> with the device. This is often overlooked. I view it as similar to software that has a bad, poorly documented API. No one, not even future you, will know how to operate your device unless you are careful about its interface and documentation.</p>
<p>We will again use the setup of the last few lessons with the same utility functions.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">find_arduino</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the name of the port that is connected to Arduino.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ports</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">list_ports</span><span class="o">.</span><span class="n">comports</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ports</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">manufacturer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;Arduino&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">manufacturer</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">device</span>
    <span class="k">return</span> <span class="n">port</span>


<span class="k">def</span> <span class="nf">handshake_arduino</span><span class="p">(</span>
    <span class="n">arduino</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">print_handshake_message</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">handshake_code</span><span class="o">=</span><span class="mi">0</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make sure connection is established by sending</span>
<span class="sd">    and receiving bytes.&quot;&quot;&quot;</span>
    <span class="c1"># Close and reopen</span>
    <span class="n">arduino</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">arduino</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

    <span class="c1"># Chill out while everything gets set</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>

    <span class="c1"># Set a long timeout to complete handshake</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="n">arduino</span><span class="o">.</span><span class="n">timeout</span>
    <span class="n">arduino</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># Read and discard everything that may be in the input buffer</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">arduino</span><span class="o">.</span><span class="n">read_all</span><span class="p">()</span>

    <span class="c1"># Send request to Arduino</span>
    <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">handshake_code</span><span class="p">]))</span>

    <span class="c1"># Read in what Arduino sent</span>
    <span class="n">handshake_message</span> <span class="o">=</span> <span class="n">arduino</span><span class="o">.</span><span class="n">read_until</span><span class="p">()</span>

    <span class="c1"># Send and receive request again</span>
    <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">handshake_code</span><span class="p">]))</span>
    <span class="n">handshake_message</span> <span class="o">=</span> <span class="n">arduino</span><span class="o">.</span><span class="n">read_until</span><span class="p">()</span>

    <span class="c1"># Print the handshake message, if desired</span>
    <span class="k">if</span> <span class="n">print_handshake_message</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Handshake message: &quot;</span> <span class="o">+</span> <span class="n">handshake_message</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

    <span class="c1"># Reset the timeout</span>
    <span class="n">arduino</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>


<span class="k">def</span> <span class="nf">read_all</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span> <span class="n">read_buffer</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read all available bytes from the serial port</span>
<span class="sd">    and append to the read buffer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ser : serial.Serial() instance</span>
<span class="sd">        The device we are reading from.</span>
<span class="sd">    read_buffer : bytes, default b&#39;&#39;</span>
<span class="sd">        Previous read buffer that is appended to.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output : bytes</span>
<span class="sd">        Bytes object that contains read_buffer + read.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. `**args` appears, but is never used. This is for</span>
<span class="sd">       compatibility with `read_all_newlines()` as a</span>
<span class="sd">       drop-in replacement for this function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set timeout to None to make sure we read all bytes</span>
    <span class="n">previous_timeout</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">timeout</span>
    <span class="n">ser</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">in_waiting</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">in_waiting</span>
    <span class="n">read</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">in_waiting</span><span class="p">)</span>

    <span class="c1"># Reset to previous timeout</span>
    <span class="n">ser</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">previous_timeout</span>

    <span class="k">return</span> <span class="n">read_buffer</span> <span class="o">+</span> <span class="n">read</span>


<span class="k">def</span> <span class="nf">read_all_newlines</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span> <span class="n">read_buffer</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_reads</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read data in until encountering newlines.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ser : serial.Serial() instance</span>
<span class="sd">        The device we are reading from.</span>
<span class="sd">    n_reads : int</span>
<span class="sd">        The number of reads up to newlines</span>
<span class="sd">    read_buffer : bytes, default b&#39;&#39;</span>
<span class="sd">        Previous read buffer that is appended to.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output : bytes</span>
<span class="sd">        Bytes object that contains read_buffer + read.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. This is a drop-in replacement for read_all().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">read_buffer</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_reads</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">+=</span> <span class="n">ser</span><span class="o">.</span><span class="n">read_until</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">raw</span>


<span class="k">def</span> <span class="nf">parse_read</span><span class="p">(</span><span class="n">read</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a read with time, volage data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    read : byte string</span>
<span class="sd">        Byte string with comma delimited time/voltage</span>
<span class="sd">        measurements.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    time_ms : list of ints</span>
<span class="sd">        Time points in milliseconds.</span>
<span class="sd">    voltage : list of floats</span>
<span class="sd">        Voltages in volts.</span>
<span class="sd">    remaining_bytes : byte string</span>
<span class="sd">        Remaining, unparsed bytes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_ms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">voltage</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Separate independent time/voltage measurements</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;\d+|,&quot;</span><span class="p">)</span>
    <span class="n">raw_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">read</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">raw_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="n">time_ms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="n">voltage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">V</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">1023</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">time_ms</span><span class="p">,</span> <span class="n">voltage</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">time_ms</span><span class="p">,</span> <span class="n">voltage</span><span class="p">,</span> <span class="n">raw_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">parse_raw</span><span class="p">(</span><span class="n">raw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse bytes output from Arduino.&quot;&quot;&quot;</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Input must end with newline, otherwise message is incomplete.&quot;</span>
        <span class="p">)</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">V</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">1023</span>


<span class="k">def</span> <span class="nf">request_single_voltage</span><span class="p">(</span><span class="n">arduino</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ask Arduino for a single data point&quot;&quot;&quot;</span>
    <span class="c1"># Ask Arduino for data</span>
    <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">VOLTAGE_REQUEST</span><span class="p">]))</span>

    <span class="c1"># Read in the data</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">arduino</span><span class="o">.</span><span class="n">read_until</span><span class="p">()</span>

    <span class="c1"># Parse and return</span>
    <span class="k">return</span> <span class="n">parse_raw</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The physical setup is shown below.</p>
<div style="margin: auto; width: 400px;"><img alt="Arduino" src="../_images/arduino_setup.svg" /></div><p>And here is the code to upload to Arduino.</p>
<div class="highlight-arduino notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="kr">int</span> <span class="n">voltagePin</span> <span class="o">=</span> <span class="n">A0</span><span class="p">;</span>

<span class="kr">const</span> <span class="kr">int</span> <span class="n">redLEDPin</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="kr">const</span> <span class="kr">int</span> <span class="n">greenLEDPin</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="kr">const</span> <span class="kr">int</span> <span class="n">HANDSHAKE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kr">const</span> <span class="kr">int</span> <span class="n">VOLTAGE_REQUEST</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kr">const</span> <span class="kr">int</span> <span class="n">RED_LED_ON</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="kr">const</span> <span class="kr">int</span> <span class="n">RED_LED_OFF</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="kr">const</span> <span class="kr">int</span> <span class="n">GREEN_LED_ON</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="kr">const</span> <span class="kr">int</span> <span class="n">GREEN_LED_OFF</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

<span class="kr">const</span> <span class="kr">int</span> <span class="n">ON_REQUEST</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="kr">const</span> <span class="kr">int</span> <span class="n">STREAM</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="kr">const</span> <span class="kr">int</span> <span class="n">READ_DAQ_DELAY</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

<span class="kr">String</span> <span class="n">daqDelayStr</span><span class="p">;</span>

<span class="kr">int</span> <span class="n">inByte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kr">int</span> <span class="n">daqMode</span> <span class="o">=</span> <span class="n">ON_REQUEST</span><span class="p">;</span>
<span class="kr">int</span> <span class="n">daqDelay</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>   <span class="c1">// delay between acquisitions in milliseconds</span>

<span class="kr">int</span> <span class="n">value</span><span class="p">;</span>
<span class="kr">unsigned</span> <span class="kr">long</span> <span class="n">time_ms</span><span class="p">;</span>


<span class="kr">void</span> <span class="nf">printVoltage</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// read value from analog pin</span>
  <span class="n">value</span> <span class="o">=</span> <span class="nf">analogRead</span><span class="p">(</span><span class="n">voltagePin</span><span class="p">);</span>
  <span class="n">time_ms</span> <span class="o">=</span> <span class="nf">millis</span><span class="p">();</span>

  <span class="c1">// Write the result</span>
  <span class="k">if</span> <span class="p">(</span><span class="nf">Serial</span><span class="p">.</span><span class="n">availableForWrite</span><span class="p">())</span> <span class="p">{</span>
    <span class="kr">String</span> <span class="n">outstr</span> <span class="o">=</span> <span class="kr">String</span><span class="p">(</span><span class="kr">String</span><span class="p">(</span><span class="n">time_ms</span><span class="p">,</span> <span class="n">DEC</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="kr">String</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">DEC</span><span class="p">));</span>
    <span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="n">outstr</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="kr">void</span> <span class="nb">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Set LEDs to off</span>
  <span class="nf">pinMode</span><span class="p">(</span><span class="n">redLEDPin</span><span class="p">,</span> <span class="kr">OUTPUT</span><span class="p">);</span>
  <span class="nf">pinMode</span><span class="p">(</span><span class="n">greenLEDPin</span><span class="p">,</span> <span class="kr">OUTPUT</span><span class="p">);</span>
  <span class="nf">digitalWrite</span><span class="p">(</span><span class="n">redLEDPin</span><span class="p">,</span> <span class="kr">LOW</span><span class="p">);</span>
  <span class="nf">digitalWrite</span><span class="p">(</span><span class="n">greenLEDPin</span><span class="p">,</span> <span class="kr">LOW</span><span class="p">);</span>

  <span class="c1">// initialize serial communication</span>
  <span class="nf">Serial</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
<span class="p">}</span>


<span class="kr">void</span> <span class="nb">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// If we&#39;re auto-transferring data (streaming mode)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">daqMode</span> <span class="o">==</span> <span class="n">STREAM</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printVoltage</span><span class="p">();</span>
    <span class="nf">delay</span><span class="p">(</span><span class="n">daqDelay</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Check if data has been sent to Arduino and respond accordingly</span>
  <span class="k">if</span> <span class="p">(</span><span class="nf">Serial</span><span class="p">.</span><span class="nf">available</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Read in request</span>
    <span class="n">inByte</span> <span class="o">=</span> <span class="nf">Serial</span><span class="p">.</span><span class="nf">read</span><span class="p">();</span>

    <span class="c1">// Handshake</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">inByte</span> <span class="o">==</span> <span class="n">HANDSHAKE</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nf">Serial</span><span class="p">.</span><span class="n">availableForWrite</span><span class="p">())</span> <span class="p">{</span>
          <span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">&quot;Handshake message received.&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// If data is requested, fetch it and write it</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inByte</span> <span class="o">==</span> <span class="n">VOLTAGE_REQUEST</span><span class="p">)</span> <span class="n">printVoltage</span><span class="p">();</span>

    <span class="c1">// Switch daqMode</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inByte</span> <span class="o">==</span> <span class="n">ON_REQUEST</span><span class="p">)</span> <span class="n">daqMode</span> <span class="o">=</span> <span class="n">ON_REQUEST</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inByte</span> <span class="o">==</span> <span class="n">STREAM</span><span class="p">)</span> <span class="n">daqMode</span> <span class="o">=</span> <span class="n">STREAM</span><span class="p">;</span>

    <span class="c1">// Read in DAQ delay</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inByte</span> <span class="o">==</span> <span class="n">READ_DAQ_DELAY</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="nf">Serial</span><span class="p">.</span><span class="nf">available</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
      <span class="n">daqDelayStr</span> <span class="o">=</span> <span class="nf">Serial</span><span class="p">.</span><span class="nf">readStringUntil</span><span class="p">(</span><span class="sc">&#39;x&#39;</span><span class="p">);</span>
      <span class="n">daqDelay</span> <span class="o">=</span> <span class="n">daqDelayStr</span><span class="p">.</span><span class="n">toInt</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// else, turn LEDs on or off</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inByte</span> <span class="o">==</span> <span class="n">RED_LED_ON</span><span class="p">)</span> <span class="nf">digitalWrite</span><span class="p">(</span><span class="n">redLEDPin</span><span class="p">,</span> <span class="kr">HIGH</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inByte</span> <span class="o">==</span> <span class="n">RED_LED_OFF</span><span class="p">)</span> <span class="nf">digitalWrite</span><span class="p">(</span><span class="n">redLEDPin</span><span class="p">,</span> <span class="kr">LOW</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inByte</span> <span class="o">==</span> <span class="n">GREEN_LED_ON</span><span class="p">)</span> <span class="nf">digitalWrite</span><span class="p">(</span><span class="n">greenLEDPin</span><span class="p">,</span> <span class="kr">HIGH</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inByte</span> <span class="o">==</span> <span class="n">GREEN_LED_OFF</span><span class="p">)</span> <span class="nf">digitalWrite</span><span class="p">(</span><span class="n">greenLEDPin</span><span class="p">,</span> <span class="kr">LOW</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="Sketching-a-dashboard">
<h2>Sketching a dashboard<a class="headerlink" href="#Sketching-a-dashboard" title="Permalink to this headline">¶</a></h2>
<p>I find it is always helpful to first sketch how I would like my dashboard to look. The first version I came up with is this:</p>
<div style="margin: auto; width: 500px;"><img alt="Dashboard sketch v. 1" src="../_images/dashboard_sketch_1.png" />
</div><p>The idea is that I have a tabbed plot (which is possible in Bokeh). The user chooses either to be in streaming mode or to be in on-demand mode by selecting the tab. Streaming starts by pressing the start button (it is “Acquire” in on-demand mode), and stops by pressing the stop button. Streaming is allowed to begin again by again pressing start. To save the data, the user can enter a file name and click the save button.</p>
<p>I built this app, and then realized some problems with it.</p>
<ol class="arabic simple">
<li><p>It is ambiguous whether to save streaming or on-demand data in the event that both are happening at the same time.</p></li>
<li><p>There actually is no stop button for on-demand. (Duh!)</p></li>
<li><p>If data are streaming and the user switches to on-demand mode, the user cannot see the streaming data anymore.</p></li>
</ol>
<p>I scrapped this design and moved on to another.</p>
<div style="margin: auto; width: 500px;"><img alt="Dashboard sketch v. 2" src="../_images/dashboard_sketch_2.png" />
</div><p>This version alleviates the problems mentioned above. The “stream” button on the stream box of the app is a toggle button, meaning that once pressed, it stays on until pressed again. Thus, one button controls whether streaming is on or off.</p>
<p>I also added reset buttons to both. Clicking the reset button clears the data (and stops streaming if streaming is still active) allowing fresh data to be collected.</p>
<p>After considering this design, I decided I wanted to add two more features.</p>
<ol class="arabic simple">
<li><p>An indicator as if data had been saved to a file under the “save” button.</p></li>
<li><p>An option to shut down the app. In the shutdown procedure, the asynchronous data acquisition is halted and Arduino is disconnected. In the stand-alone app (that is, outside of a Jupyter notebook), the server is also shut down.</p></li>
</ol>
<p>The final design I sketched is show below.</p>
<div style="margin: auto; width: 500px;"><img alt="Dashboard sketch v. 3" src="../_images/dashboard_sketch_3.png" />
</div><p>In a moment, we’ll build the components of the app: the buttons, the text inputs, the plots. First, though, we need to connect to Arduino and set up the data acquisition.</p>
</div>
<div class="section" id="Connecting-to-Arduino-and-opening-DAQ">
<h2>Connecting to Arduino and opening DAQ<a class="headerlink" href="#Connecting-to-Arduino-and-opening-DAQ" title="Permalink to this headline">¶</a></h2>
<p>First, we’ll open connection to Arduino in the same way we have been in the past several lessons.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">HANDSHAKE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">VOLTAGE_REQUEST</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">RED_LED_ON</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">RED_LED_OFF</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">GREEN_LED_ON</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">GREEN_LED_OFF</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ON_REQUEST</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">STREAM</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">READ_DAQ_DELAY</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># Windows users may need to give COM port for find_arduino()</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">find_arduino</span><span class="p">()</span>

<span class="c1"># Connect and handshake</span>
<span class="n">arduino</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">)</span>
<span class="n">handshake_arduino</span><span class="p">(</span><span class="n">arduino</span><span class="p">,</span> <span class="n">print_handshake_message</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Handshake message: Handshake message received.

</pre></div></div>
</div>
<p>Next, we need to have variables to store data coming in from streaming and on-demand. These need to be mutable objects that we can pass into data collection functions and into the function defining the Bokeh app. We will therefore use dictionaries of lists, one for streaming data and one for on-demand data. For the streaming dictionary, we should also keep two other variables, the mode of data acquisition (either <code class="docutils literal notranslate"><span class="pre">'stream'</span></code> or <code class="docutils literal notranslate"><span class="pre">'on</span> <span class="pre">demand'</span></code>), and a variable to keep track of the array length
of the data currently on the streaming plot. We need to keep that reference so we know which data points to add to the plot after each acquisition, since we acquire more than one data point at a time.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Set up data dictionaries</span>
<span class="n">stream_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prev_array_length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="p">[],</span> <span class="n">V</span><span class="o">=</span><span class="p">[],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;on demand&#39;</span><span class="p">)</span>
<span class="n">on_demand_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="p">[],</span> <span class="n">V</span><span class="o">=</span><span class="p">[])</span>
</pre></div>
</div>
</div>
<p>Finally, we’ll set up the data stream. We have to have another layer of logic here. If the <code class="docutils literal notranslate"><span class="pre">mode</span></code> entry in the <code class="docutils literal notranslate"><span class="pre">steam_data</span></code> dictionary changes to <code class="docutils literal notranslate"><span class="pre">'stream'</span></code>, we need to set Arduino to stream mode. We only want to do this when it changes to <code class="docutils literal notranslate"><span class="pre">'stream'</span></code>, not on every data acquisition, so we also have a local variable <code class="docutils literal notranslate"><span class="pre">stream_on</span></code> that keeps track of whether or not Arduino has been instructed to stream data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">daq_stream_async</span><span class="p">(</span>
    <span class="n">arduino</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_trash_reads</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_reads_per_chunk</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">reader</span><span class="o">=</span><span class="n">read_all_newlines</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Obtain streaming data&quot;&quot;&quot;</span>
    <span class="c1"># Specify delay</span>
    <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">READ_DAQ_DELAY</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="c1"># Current streaming state</span>
    <span class="n">stream_on</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Receive data</span>
    <span class="n">read_buffer</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span>
            <span class="c1"># Turn on the stream if need be</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stream_on</span><span class="p">:</span>
                <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">STREAM</span><span class="p">]))</span>

                <span class="c1"># Read and throw out first few reads</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_trash_reads</span><span class="p">:</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">arduino</span><span class="o">.</span><span class="n">read_until</span><span class="p">()</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">stream_on</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Read in chunk of data</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span>
                <span class="n">arduino</span><span class="p">,</span> <span class="n">read_buffer</span><span class="o">=</span><span class="n">read_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_reads</span><span class="o">=</span><span class="n">n_reads_per_chunk</span>
            <span class="p">)</span>

            <span class="c1"># Parse it, passing if it is gibberish</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">read_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_read</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>

                <span class="c1"># Update data dictionary</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">t</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">V</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Make sure stream is off</span>
            <span class="n">stream_on</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Sleep 80% of the time before we need to start reading chunks</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">n_reads_per_chunk</span> <span class="o">*</span> <span class="n">delay</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>


<span class="n">daq_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">daq_stream_async</span><span class="p">(</span><span class="n">arduino</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Building-the-app">
<h2>Building the app<a class="headerlink" href="#Building-the-app" title="Permalink to this headline">¶</a></h2>
<p>The completed app needs to be contained in a single function that Bokeh can use to create the app. To practice modular programming, we will write functions to build the parts of the app one by one. These functions can then be used within the function defining the app.</p>
<p>We’ll start by defining the plots. When we build the plot, as before, we have to be sure to specify a <code class="docutils literal notranslate"><span class="pre">ColumnDataSource</span></code>.</p>
<p>We also need to play a little trick. With no glyphs on a plot, Bokeh does not know how to set the axes. So, we need to provide “phantom” data to the plot. We specify a phantom data source that give coordinates for a single glyph, an invisible circle.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build a plot of voltage vs time data&quot;&quot;&quot;</span>
    <span class="c1"># Set up plot area</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span>
        <span class="n">frame_width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">frame_height</span><span class="o">=</span><span class="mi">175</span><span class="p">,</span>
        <span class="n">x_axis_label</span><span class="o">=</span><span class="s2">&quot;time (s)&quot;</span><span class="p">,</span>
        <span class="n">y_axis_label</span><span class="o">=</span><span class="s2">&quot;voltage (V)&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;streaming data&quot;</span><span class="p">,</span>
        <span class="n">y_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">5.2</span><span class="p">],</span>
        <span class="n">toolbar_location</span><span class="o">=</span><span class="s2">&quot;above&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># No range padding on x: signal spans whole plot</span>
    <span class="n">p</span><span class="o">.</span><span class="n">x_range</span><span class="o">.</span><span class="n">range_padding</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># We&#39;ll sue whitesmoke backgrounds</span>
    <span class="n">p</span><span class="o">.</span><span class="n">border_fill_color</span> <span class="o">=</span> <span class="s2">&quot;whitesmoke&quot;</span>

    <span class="c1"># Defined the data source</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="p">[],</span> <span class="n">V</span><span class="o">=</span><span class="p">[]))</span>

    <span class="c1"># If we are in streaming mode, use a line, dots for on-demand</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;stream&#39;</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;V&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;V&quot;</span><span class="p">)</span>

    <span class="c1"># Put a phantom circle so axis labels show before data arrive</span>
    <span class="n">phantom_source</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">V</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">phantom_source</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">phantom_source</span>
</pre></div>
</div>
</div>
<p>Next, we need to build the controls and indicators. Each has a green button for acquiring data, an orange button to reset, a blue button to save, and a text window for entering the file name to save the data. There is also the text to indicate in which file the last data set was saved.</p>
<p>The stream control is a toggle, which stays on when clicked, as opposed to button which responds only to a single click. To instantiate a toggle, we use <code class="docutils literal notranslate"><span class="pre">bokeh.models.Toggle</span></code>. Similarly, to instantiate a button, we use <code class="docutils literal notranslate"><span class="pre">bokeh.models.Button</span></code>. Finally, we can always include an HTMV div using <code class="docutils literal notranslate"><span class="pre">bokeh.models.Div</span></code>, in this case containing text.</p>
<p>For convenience, we store the controls in a dictionary.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">controls</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span>
        <span class="n">acquire</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Toggle</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">save_notice</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;&lt;p&gt;No streaming data saved.&lt;/p&gt;&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">165</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">acquire</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;acquire&quot;</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">save_notice</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Div</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">&quot;&lt;p&gt;No on-demand data saved.&lt;/p&gt;&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">165</span>
        <span class="p">)</span>

    <span class="n">save</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">reset</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">file_input</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">TextInput</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;file name&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">165</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">acquire</span><span class="o">=</span><span class="n">acquire</span><span class="p">,</span>
        <span class="n">reset</span><span class="o">=</span><span class="n">reset</span><span class="p">,</span>
        <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span>
        <span class="n">file_input</span><span class="o">=</span><span class="n">file_input</span><span class="p">,</span>
        <span class="n">save_notice</span><span class="o">=</span><span class="n">save_notice</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<p>Next, we need to lay out the plot and controls. The three main Bokeh features we will use are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bokeh.layouts.row()</span></code>: Place elements in a row.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bokeh.layouts.column()</span></code>: Place elements in a column.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bokeh.models.Spacer</span></code>: Inset space (in units of pixels) between elements.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">layout</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">):</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">layouts</span><span class="o">.</span><span class="n">row</span><span class="p">(</span>
        <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Spacer</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
        <span class="n">ctrls</span><span class="p">[</span><span class="s2">&quot;acquire&quot;</span><span class="p">],</span>
        <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Spacer</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">295</span><span class="p">),</span>
        <span class="n">ctrls</span><span class="p">[</span><span class="s2">&quot;reset&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">layouts</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buttons</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">layouts</span><span class="o">.</span><span class="n">column</span><span class="p">(</span>
        <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Spacer</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span>
        <span class="n">ctrls</span><span class="p">[</span><span class="s2">&quot;file_input&quot;</span><span class="p">],</span>
        <span class="n">ctrls</span><span class="p">[</span><span class="s2">&quot;save&quot;</span><span class="p">],</span>
        <span class="n">ctrls</span><span class="p">[</span><span class="s2">&quot;save_notice&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">layouts</span><span class="o">.</span><span class="n">row</span><span class="p">(</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">background</span><span class="o">=</span><span class="s2">&quot;whitesmoke&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<p>To see how this layout will looks, let’s make a plot and some controls and lay them out.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">p</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">phantom_source</span> <span class="o">=</span> <span class="n">plot</span><span class="p">(</span><span class="s1">&#39;stream&#39;</span><span class="p">)</span>
<span class="n">ctrls</span> <span class="o">=</span> <span class="n">controls</span><span class="p">(</span><span class="s1">&#39;stream&#39;</span><span class="p">)</span>
<span class="n">bokeh</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">layout</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div class="bk-root" id="e12e9ccc-6bde-4b3b-bec6-6e2391cde69d" data-root-id="1059"></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="output_javascript"></div>
<script type="text/javascript">
var element = document.currentScript.previousSibling.previousSibling;
(function(root) {
  function embed_document(root) {

  var docs_json = {"7849bd39-b4aa-4fc3-b7c6-89e607027080":{"defs":[],"roots":{"references":[{"attributes":{"background":"whitesmoke","children":[{"id":"1056"},{"id":"1058"}],"margin":[30,30,30,30],"spacing":30},"id":"1059","type":"Row"},{"attributes":{"fill_color":{"value":"#1f77b4"},"line_color":{"value":"#1f77b4"},"x":{"field":"t"},"y":{"field":"V"}},"id":"1044","type":"Circle"},{"attributes":{"axis_label":"time (s)","formatter":{"id":"1061"},"major_label_policy":{"id":"1062"},"ticker":{"id":"1015"}},"id":"1014","type":"LinearAxis"},{"attributes":{"line_alpha":0.1,"line_color":"#1f77b4","x":{"field":"t"},"y":{"field":"V"}},"id":"1039","type":"Line"},{"attributes":{},"id":"1012","type":"LinearScale"},{"attributes":{},"id":"1069","type":"Selection"},{"attributes":{"children":[{"id":"1053"},{"id":"1048"},{"id":"1054"},{"id":"1051"}]},"id":"1055","type":"Row"},{"attributes":{"data_source":{"id":"1036"},"glyph":{"id":"1038"},"hover_glyph":null,"muted_glyph":null,"nonselection_glyph":{"id":"1039"},"view":{"id":"1041"}},"id":"1040","type":"GlyphRenderer"},{"attributes":{},"id":"1027","type":"HelpTool"},{"attributes":{},"id":"1062","type":"AllLabels"},{"attributes":{"active_multi":null,"tools":[{"id":"1022"},{"id":"1023"},{"id":"1024"},{"id":"1025"},{"id":"1026"},{"id":"1027"}]},"id":"1029","type":"Toolbar"},{"attributes":{"fill_alpha":{"value":0.1},"fill_color":{"value":"#1f77b4"},"line_alpha":{"value":0.1},"line_color":{"value":"#1f77b4"},"x":{"field":"t"},"y":{"field":"V"}},"id":"1045","type":"Circle"},{"attributes":{},"id":"1068","type":"UnionRenderers"},{"attributes":{},"id":"1070","type":"UnionRenderers"},{"attributes":{"data_source":{"id":"1042"},"glyph":{"id":"1044"},"hover_glyph":null,"muted_glyph":null,"nonselection_glyph":{"id":"1045"},"view":{"id":"1047"},"visible":false},"id":"1046","type":"GlyphRenderer"},{"attributes":{},"id":"1025","type":"SaveTool"},{"attributes":{},"id":"1026","type":"ResetTool"},{"attributes":{"axis":{"id":"1014"},"ticker":null},"id":"1017","type":"Grid"},{"attributes":{"source":{"id":"1036"}},"id":"1041","type":"CDSView"},{"attributes":{"children":[{"id":"1003"},{"id":"1055"}],"spacing":15},"id":"1056","type":"Column"},{"attributes":{"range_padding":0},"id":"1006","type":"DataRange1d"},{"attributes":{"data":{"V":[0],"t":[0]},"selected":{"id":"1069"},"selection_policy":{"id":"1070"}},"id":"1042","type":"ColumnDataSource"},{"attributes":{"line_color":"#1f77b4","x":{"field":"t"},"y":{"field":"V"}},"id":"1038","type":"Line"},{"attributes":{"text":"<p>No streaming data saved.</p>","width":165},"id":"1049","type":"Div"},{"attributes":{},"id":"1019","type":"BasicTicker"},{"attributes":{"source":{"id":"1042"}},"id":"1047","type":"CDSView"},{"attributes":{"children":[{"id":"1057"},{"id":"1052"},{"id":"1050"},{"id":"1049"}]},"id":"1058","type":"Column"},{"attributes":{"title":"file name","value":"stream.csv","width":165},"id":"1052","type":"TextInput"},{"attributes":{"bottom_units":"screen","fill_alpha":0.5,"fill_color":"lightgrey","left_units":"screen","level":"overlay","line_alpha":1.0,"line_color":"black","line_dash":[4,4],"line_width":2,"right_units":"screen","syncable":false,"top_units":"screen"},"id":"1028","type":"BoxAnnotation"},{"attributes":{"data":{"V":[],"t":[]},"selected":{"id":"1067"},"selection_policy":{"id":"1068"}},"id":"1036","type":"ColumnDataSource"},{"attributes":{"button_type":"success","icon":null,"label":"stream","width":100},"id":"1048","type":"Toggle"},{"attributes":{},"id":"1022","type":"PanTool"},{"attributes":{"overlay":{"id":"1028"}},"id":"1024","type":"BoxZoomTool"},{"attributes":{"button_type":"warning","icon":null,"label":"reset","width":100},"id":"1051","type":"Button"},{"attributes":{"axis":{"id":"1018"},"dimension":1,"ticker":null},"id":"1021","type":"Grid"},{"attributes":{"width":30},"id":"1053","type":"Spacer"},{"attributes":{"height":50},"id":"1057","type":"Spacer"},{"attributes":{"button_type":"primary","icon":null,"label":"save","width":100},"id":"1050","type":"Button"},{"attributes":{},"id":"1010","type":"LinearScale"},{"attributes":{"width":295},"id":"1054","type":"Spacer"},{"attributes":{},"id":"1015","type":"BasicTicker"},{"attributes":{},"id":"1065","type":"AllLabels"},{"attributes":{},"id":"1067","type":"Selection"},{"attributes":{},"id":"1061","type":"BasicTickFormatter"},{"attributes":{"below":[{"id":"1014"}],"border_fill_color":"whitesmoke","center":[{"id":"1017"},{"id":"1021"}],"frame_height":175,"frame_width":500,"left":[{"id":"1018"}],"renderers":[{"id":"1040"},{"id":"1046"}],"title":{"id":"1004"},"toolbar":{"id":"1029"},"toolbar_location":"above","x_range":{"id":"1006"},"x_scale":{"id":"1010"},"y_range":{"id":"1008"},"y_scale":{"id":"1012"}},"id":"1003","subtype":"Figure","type":"Plot"},{"attributes":{"text":"streaming data"},"id":"1004","type":"Title"},{"attributes":{"end":5.2,"start":-0.2},"id":"1008","type":"Range1d"},{"attributes":{},"id":"1023","type":"WheelZoomTool"},{"attributes":{"axis_label":"voltage (V)","formatter":{"id":"1064"},"major_label_policy":{"id":"1065"},"ticker":{"id":"1019"}},"id":"1018","type":"LinearAxis"},{"attributes":{},"id":"1064","type":"BasicTickFormatter"}],"root_ids":["1059"]},"title":"Bokeh Application","version":"2.3.2"}};
  var render_items = [{"docid":"7849bd39-b4aa-4fc3-b7c6-89e607027080","root_ids":["1059"],"roots":{"1059":"e12e9ccc-6bde-4b3b-bec6-6e2391cde69d"}}];
  root.Bokeh.embed.embed_items_notebook(docs_json, render_items);

  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    var attempts = 0;
    var timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);
</script></div>
</div>
<p>Looks good!</p>
<p>Clicking any of the buttons above will not do anything. This is because they are not connected to any callbacks, or functions that are executed when the button or toggle is clicked. We need to write the callback functions for each.</p>
<p>We’ll start with the callback for pressing the “acquire” button to get a single on-demand data point. When we ask for data while steaming is happening, we can just pick off the last streamed data point. Otherwise, we ask for a single voltage. In either case, we append the new data point to our on-demand data dictionary. We also updated the data source to include the new data point. To do this, we use the <code class="docutils literal notranslate"><span class="pre">stream()</span></code> method of a Bokeh <code class="docutils literal notranslate"><span class="pre">ColumnDataSource</span></code>. Using this function allows for rapid
update of the plot. Only the new data are added; the plot is not re-rendered.</p>
<p>Finally, we need to update the phantom data point to be the new data point to keep the ranges of the x-axis reasonable.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">acquire_callback</span><span class="p">(</span><span class="n">arduino</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">phantom_source</span><span class="p">,</span> <span class="n">rollover</span><span class="p">):</span>
    <span class="c1"># Pull t and V values from stream or request from Arduino</span>
    <span class="k">if</span> <span class="n">stream_data</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">stream_data</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">stream_data</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">request_single_voltage</span><span class="p">(</span><span class="n">arduino</span><span class="p">)</span>

    <span class="c1"># Add to on-demand data dictionary</span>
    <span class="n">on_demand_data</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">on_demand_data</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

    <span class="c1"># Send new data to plot</span>
    <span class="n">new_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="p">[</span><span class="n">t</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">],</span> <span class="n">V</span><span class="o">=</span><span class="p">[</span><span class="n">V</span><span class="p">])</span>
    <span class="n">source</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">rollover</span><span class="o">=</span><span class="n">rollover</span><span class="p">)</span>

    <span class="c1"># Update the phantom source to keep the x_range on plot ok</span>
    <span class="n">phantom_source</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">new_data</span>
</pre></div>
</div>
</div>
<p>Next, we’ll write the callback for clicking the “stream” toggle. If we turn the stream on, that is if the new value of the toggle is <code class="docutils literal notranslate"><span class="pre">True</span></code>, we need to switch to streaming mode. (We do not need to tell Arduino to turn streaming on here; we already did that in our asynchronous DAQ function.) If we turn the toggle off, though (<code class="docutils literal notranslate"><span class="pre">new</span></code> is <code class="docutils literal notranslate"><span class="pre">False</span></code>), then we switch the mode to on-demand and tell Arduino to wait for requests to send data. Finally, just in case Arduino sent any incomplete messages
while we were trying to tell it what to do, we should clear the input buffer on the Python side.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">stream_callback</span><span class="p">(</span><span class="n">arduino</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">new</span><span class="p">:</span>
        <span class="n">stream_data</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;stream&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stream_data</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on-demand&quot;</span>
        <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">ON_REQUEST</span><span class="p">]))</span>

    <span class="n">arduino</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Next, we’ll code up the callback of the reset buttons. If we’re in streaming mode, we turn off the stream. Then, we clear out all of the arrays and sources holding data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">reset_callback</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">phantom_source</span><span class="p">,</span> <span class="n">controls</span><span class="p">):</span>
    <span class="c1"># Turn off the stream</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span>
        <span class="n">controls</span><span class="p">[</span><span class="s2">&quot;acquire&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Black out the data dictionaries</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Reset the sources</span>
    <span class="n">source</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="p">[],</span> <span class="n">V</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">phantom_source</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">V</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Next is the save callback. In this case, we want to take the data in the data dictionary, put them in a Pandas data frame, and then write the results to the CSV file specified in the input window. We also need to update the notice text below the “save” button to indicate what we did.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">save_callback</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">controls</span><span class="p">):</span>
    <span class="c1"># Convert data to data frame and save</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;time (ms)&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">],</span> <span class="s2">&quot;voltage (V)&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="s2">&quot;file_input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Update notice text</span>
    <span class="n">notice_text</span> <span class="o">=</span> <span class="s2">&quot;&lt;p&gt;&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;Streaming&quot;</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span> <span class="k">else</span> <span class="s2">&quot;On-demand&quot;</span><span class="p">)</span>
    <span class="n">notice_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; data was last saved to </span><span class="si">{</span><span class="n">controls</span><span class="p">[</span><span class="s1">&#39;file_input&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">.&lt;/p&gt;&quot;</span>
    <span class="n">controls</span><span class="p">[</span><span class="s2">&quot;save_notice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">notice_text</span>
</pre></div>
</div>
</div>
<p>We’re almost there. For the shutdown callback, we need to disable all of the controls. We do this by setting their <code class="docutils literal notranslate"><span class="pre">disabled</span></code> attribute to <code class="docutils literal notranslate"><span class="pre">True</span></code>. We also want to turn off the data stream, cancel the asynchronous data acquisition task, and close the connection to Arduino. Upon shutdown, the app is dead.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">disable_controls</span><span class="p">(</span><span class="n">controls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Disable all controls.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">controls</span><span class="p">:</span>
        <span class="n">controls</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">shutdown_callback</span><span class="p">(</span>
    <span class="n">arduino</span><span class="p">,</span> <span class="n">daq_task</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">,</span> <span class="n">stream_controls</span><span class="p">,</span> <span class="n">on_demand_controls</span>
<span class="p">):</span>
    <span class="c1"># Disable controls</span>
    <span class="n">disable_controls</span><span class="p">(</span><span class="n">stream_controls</span><span class="p">)</span>
    <span class="n">disable_controls</span><span class="p">(</span><span class="n">on_demand_controls</span><span class="p">)</span>

    <span class="c1"># Strop streaming</span>
    <span class="n">stream_data</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;on-demand&quot;</span>
    <span class="n">arduino</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="n">ON_REQUEST</span><span class="p">]))</span>

    <span class="c1"># Stop DAQ async task</span>
    <span class="n">daq_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="c1"># Disconnect from Arduino</span>
    <span class="n">arduino</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>And now for our final callback. This callback is called automatically by Bokeh on a regular time interval by adding it as a periodic callback. We stream the data to the source and also adjust the phantom data. Finally, it is important to keep track of the previous array length, as in the previous lesson.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">stream_update</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">phantom_source</span><span class="p">,</span> <span class="n">rollover</span><span class="p">):</span>
    <span class="c1"># Update plot by streaming in data</span>
    <span class="n">new_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">][</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;prev_array_length&quot;</span><span class="p">]</span> <span class="p">:])</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">][</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;prev_array_length&quot;</span><span class="p">]</span> <span class="p">:],</span>
    <span class="p">}</span>
    <span class="n">source</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">rollover</span><span class="p">)</span>

    <span class="c1"># Adjust new phantom data point if new data arrived</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">phantom_source</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="p">[</span><span class="n">new_data</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">V</span><span class="o">=</span><span class="p">[</span><span class="n">new_data</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;prev_array_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>We now have the functions we need to build the app. As we build the app, there are a few considerations to keep in mind.</p>
<ol class="arabic simple">
<li><p>The callbacks within the app must have a specific call signature. A button must have a callback with signature <code class="docutils literal notranslate"><span class="pre">callback(event=None)</span></code> and a toggle must have a callback with signature <code class="docutils literal notranslate"><span class="pre">callback(attr,</span> <span class="pre">old,</span> <span class="pre">new)</span></code>. So, within the app, we define callbacks with these signatures that call the functions we have defined above.</p></li>
<li><p>If we are running the app outside of JupyterLab, the shut down button should also stop the Bokeh server. We can accomplish this by checking if the connection to Arduino is open in the periodic callback, and if it is closed, we terminate the app using <code class="docutils literal notranslate"><span class="pre">sys.exit()</span></code>.</p></li>
<li><p>The callbacks we wrote need to be <strong>linked</strong> to the appropriate buttons and toggles. We do this using the <code class="docutils literal notranslate"><span class="pre">on_click()</span></code> and <code class="docutils literal notranslate"><span class="pre">on_change()</span></code> methods of the buttons and toggles.</p></li>
</ol>
<p>With these in mind, we can construct our app.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">potentiometer_app</span><span class="p">(</span>
    <span class="n">arduino</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">,</span> <span class="n">on_demand_data</span><span class="p">,</span> <span class="n">daq_task</span><span class="p">,</span> <span class="n">rollover</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">stream_plot_delay</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">def</span> <span class="nf">_app</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
        <span class="c1"># Plots</span>
        <span class="n">p_stream</span><span class="p">,</span> <span class="n">stream_source</span><span class="p">,</span> <span class="n">stream_phantom_source</span> <span class="o">=</span> <span class="n">plot</span><span class="p">(</span><span class="s2">&quot;stream&quot;</span><span class="p">)</span>
        <span class="n">p_on_demand</span><span class="p">,</span> <span class="n">on_demand_source</span><span class="p">,</span> <span class="n">on_demand_phantom_source</span> <span class="o">=</span> <span class="n">plot</span><span class="p">(</span><span class="s2">&quot;on demand&quot;</span><span class="p">)</span>

        <span class="c1"># Controls</span>
        <span class="n">stream_controls</span> <span class="o">=</span> <span class="n">controls</span><span class="p">(</span><span class="s2">&quot;stream&quot;</span><span class="p">)</span>
        <span class="n">on_demand_controls</span> <span class="o">=</span> <span class="n">controls</span><span class="p">(</span><span class="s2">&quot;on_demand&quot;</span><span class="p">)</span>

        <span class="c1"># Shut down</span>
        <span class="n">shutdown_button</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;shut down&quot;</span><span class="p">,</span> <span class="n">button_type</span><span class="o">=</span><span class="s2">&quot;danger&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span>
        <span class="p">)</span>

        <span class="c1"># Layouts</span>
        <span class="n">stream_layout</span> <span class="o">=</span> <span class="n">layout</span><span class="p">(</span><span class="n">p_stream</span><span class="p">,</span> <span class="n">stream_controls</span><span class="p">)</span>
        <span class="n">on_demand_layout</span> <span class="o">=</span> <span class="n">layout</span><span class="p">(</span><span class="n">p_on_demand</span><span class="p">,</span> <span class="n">on_demand_controls</span><span class="p">)</span>

        <span class="c1"># Shut down layout</span>
        <span class="n">shutdown_layout</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">layouts</span><span class="o">.</span><span class="n">row</span><span class="p">(</span>
            <span class="n">bokeh</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Spacer</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">675</span><span class="p">),</span> <span class="n">shutdown_button</span>
        <span class="p">)</span>

        <span class="n">app_layout</span> <span class="o">=</span> <span class="n">bokeh</span><span class="o">.</span><span class="n">layouts</span><span class="o">.</span><span class="n">column</span><span class="p">(</span>
            <span class="n">stream_layout</span><span class="p">,</span> <span class="n">on_demand_layout</span><span class="p">,</span> <span class="n">shutdown_layout</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">_acquire_callback</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">acquire_callback</span><span class="p">(</span>
                <span class="n">arduino</span><span class="p">,</span>
                <span class="n">stream_data</span><span class="p">,</span>
                <span class="n">on_demand_source</span><span class="p">,</span>
                <span class="n">on_demand_phantom_source</span><span class="p">,</span>
                <span class="n">rollover</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">_stream_callback</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
            <span class="n">stream_callback</span><span class="p">(</span><span class="n">arduino</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_stream_reset_callback</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">reset_callback</span><span class="p">(</span>
                <span class="s2">&quot;stream&quot;</span><span class="p">,</span>
                <span class="n">stream_data</span><span class="p">,</span>
                <span class="n">stream_source</span><span class="p">,</span>
                <span class="n">stream_phantom_source</span><span class="p">,</span>
                <span class="n">stream_controls</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">_on_demand_reset_callback</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">reset_callback</span><span class="p">(</span>
                <span class="s2">&quot;on demand&quot;</span><span class="p">,</span>
                <span class="n">on_demand_data</span><span class="p">,</span>
                <span class="n">on_demand_source</span><span class="p">,</span>
                <span class="n">on_demand_phantom_source</span><span class="p">,</span>
                <span class="n">on_demand_controls</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">_stream_save_callback</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">save_callback</span><span class="p">(</span><span class="s2">&quot;stream&quot;</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">,</span> <span class="n">stream_controls</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_on_demand_save_callback</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">save_callback</span><span class="p">(</span><span class="s2">&quot;on demand&quot;</span><span class="p">,</span> <span class="n">on_demand_data</span><span class="p">,</span> <span class="n">on_demand_controls</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_shutdown_callback</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">shutdown_callback</span><span class="p">(</span>
                <span class="n">arduino</span><span class="p">,</span> <span class="n">daq_task</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">,</span> <span class="n">stream_controls</span><span class="p">,</span> <span class="n">on_demand_controls</span>
            <span class="p">)</span>

        <span class="nd">@bokeh</span><span class="o">.</span><span class="n">driving</span><span class="o">.</span><span class="n">linear</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">_stream_update</span><span class="p">(</span><span class="n">step</span><span class="p">):</span>
            <span class="n">stream_update</span><span class="p">(</span><span class="n">stream_data</span><span class="p">,</span> <span class="n">stream_source</span><span class="p">,</span> <span class="n">stream_phantom_source</span><span class="p">,</span> <span class="n">rollover</span><span class="p">)</span>

            <span class="c1"># Shut down server if Arduino disconnects (commented out in Jupyter notebook)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arduino</span><span class="o">.</span><span class="n">is_open</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="c1"># Link callbacks</span>
        <span class="n">stream_controls</span><span class="p">[</span><span class="s2">&quot;acquire&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">on_change</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="n">_stream_callback</span><span class="p">)</span>
        <span class="n">stream_controls</span><span class="p">[</span><span class="s2">&quot;reset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">_stream_reset_callback</span><span class="p">)</span>
        <span class="n">stream_controls</span><span class="p">[</span><span class="s2">&quot;save&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">_stream_save_callback</span><span class="p">)</span>
        <span class="n">on_demand_controls</span><span class="p">[</span><span class="s2">&quot;acquire&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">_acquire_callback</span><span class="p">)</span>
        <span class="n">on_demand_controls</span><span class="p">[</span><span class="s2">&quot;reset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">_on_demand_reset_callback</span><span class="p">)</span>
        <span class="n">on_demand_controls</span><span class="p">[</span><span class="s2">&quot;save&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">_on_demand_save_callback</span><span class="p">)</span>
        <span class="n">shutdown_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">_shutdown_callback</span><span class="p">)</span>

        <span class="c1"># Add the layout to the app</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">add_root</span><span class="p">(</span><span class="n">app_layout</span><span class="p">)</span>

        <span class="c1"># Add a periodic callback, monitor changes in stream data</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">add_periodic_callback</span><span class="p">(</span><span class="n">_stream_update</span><span class="p">,</span> <span class="n">stream_plot_delay</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_app</span>
</pre></div>
</div>
</div>
<p>Great! Now, let’s run it. (Unfortunately, the beautiful app will not be displayed in the static HTML rendering of this lesson.)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bokeh</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">show</span><span class="p">(</span>
    <span class="n">potentiometer_app</span><span class="p">(</span><span class="n">arduino</span><span class="p">,</span> <span class="n">stream_data</span><span class="p">,</span> <span class="n">on_demand_data</span><span class="p">,</span> <span class="n">daq_task</span><span class="p">),</span>
    <span class="n">notebook_url</span><span class="o">=</span><span class="n">notebook_url</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<script id="1132">
  var xhr = new XMLHttpRequest()
  xhr.responseType = 'blob';
  xhr.open('GET', "http://localhost:55817/autoload.js?bokeh-autoload-element=1132&bokeh-absolute-url=http://localhost:55817&resources=none", true);

  xhr.onload = function (event) {
    var script = document.createElement('script'),
    src = URL.createObjectURL(event.target.response);
    script.src = src;
    document.body.appendChild(script);
  };
xhr.send();
</script></div>
</div>
<p>If you are using this app in a running Jupyter notebook, be sure to click the <code class="docutils literal notranslate"><span class="pre">shut</span> <span class="pre">down</span></code> button to shut close the connection to Arduino.</p>
</div>
<div class="section" id="Aside:-error-checking">
<h2>Aside: error checking<a class="headerlink" href="#Aside:-error-checking" title="Permalink to this headline">¶</a></h2>
<p>This app does not have much error checking. What kinds of features and checks would you add to this app to ensure that a careless user does not end up messing things up? Here are some safeguards to think about.</p>
<ol class="arabic simple">
<li><p>The user can overwrite files. There is no check to see if the file name given in for saving the data corresponds to a file that already exists.</p></li>
<li><p>There is also no check to see if the user enters a valid path for the file name.</p></li>
<li><p>The data set could get very large is the app is left on and streaming. This could overrun the available RAM.</p></li>
<li><p>The app assumed all connections with Arduino are working and does not give the user an indication that that is the case. I think adding a connection status div to the app would be a good idea.</p></li>
</ol>
</div>
<div class="section" id="A-stand-alone-app">
<h2>A stand-alone app<a class="headerlink" href="#A-stand-alone-app" title="Permalink to this headline">¶</a></h2>
<p>While running the app in a Jupyter notebook is nice, for day-to-day use of our instrument and the associated app, we would like it to stand alone. That is, we would like to launch the app, have our own tab in a browser containing only the app, and then use it like a control panel for our instrument.</p>
<p>To do this, we need to create a <code class="docutils literal notranslate"><span class="pre">.py</span></code> file with all of the above code for our app, and then <strong>serve</strong> it using Bokeh. If you save the code below in a <code class="docutils literal notranslate"><span class="pre">.py</span></code> files called <code class="docutils literal notranslate"><span class="pre">potentiometer_app.py</span></code>, you can then serve it using</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bokeh serve --show potentiometer_app.py
</pre></div>
</div>
<p>The code looks intimidating, but it is simply a copy of everything we have above, with the only exception being that we are choosing not to print the handshake message.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;&quot;&quot;
App to read in varying voltages from Arduino.

To serve the app, run

    bokeh serve --show potentiometer_app.py

on the command line.
&quot;&quot;&quot;

import asyncio
import re
import sys
import time

import numpy as np
import pandas as pd

import serial
import serial.tools.list_ports

import bokeh.plotting
import bokeh.io
import bokeh.layouts
import bokeh.driving


def find_arduino(port=None):
    &quot;&quot;&quot;Get the name of the port that is connected to Arduino.&quot;&quot;&quot;
    if port is None:
        ports = serial.tools.list_ports.comports()
        for p in ports:
            if p.manufacturer is not None and &quot;Arduino&quot; in p.manufacturer:
                port = p.device
    return port


def handshake_arduino(
    arduino, sleep_time=1, print_handshake_message=False, handshake_code=0
):
    &quot;&quot;&quot;Make sure connection is established by sending
    and receiving bytes.&quot;&quot;&quot;
    # Close and reopen
    arduino.close()
    arduino.open()

    # Chill out while everything gets set
    time.sleep(sleep_time)

    # Set a long timeout to complete handshake
    timeout = arduino.timeout
    arduino.timeout = 2

    # Read and discard everything that may be in the input buffer
    _ = arduino.read_all()

    # Send request to Arduino
    arduino.write(bytes([handshake_code]))

    # Read in what Arduino sent
    handshake_message = arduino.read_until()

    # Send and receive request again
    arduino.write(bytes([handshake_code]))
    handshake_message = arduino.read_until()

    # Print the handshake message, if desired
    if print_handshake_message:
        print(&quot;Handshake message: &quot; + handshake_message.decode())

    # Reset the timeout
    arduino.timeout = timeout


def read_all(ser, read_buffer=b&quot;&quot;, **args):
    &quot;&quot;&quot;Read all available bytes from the serial port
    and append to the read buffer.

    Parameters
    ----------
    ser : serial.Serial() instance
        The device we are reading from.
    read_buffer : bytes, default b&#39;&#39;
        Previous read buffer that is appended to.

    Returns
    -------
    output : bytes
        Bytes object that contains read_buffer + read.

    Notes
    -----
    .. `**args` appears, but is never used. This is for
       compatibility with `read_all_newlines()` as a
       drop-in replacement for this function.
    &quot;&quot;&quot;
    # Set timeout to None to make sure we read all bytes
    previous_timeout = ser.timeout
    ser.timeout = None

    in_waiting = ser.in_waiting
    read = ser.read(size=in_waiting)

    # Reset to previous timeout
    ser.timeout = previous_timeout

    return read_buffer + read


def read_all_newlines(ser, read_buffer=b&quot;&quot;, n_reads=4):
    &quot;&quot;&quot;Read data in until encountering newlines.

    Parameters
    ----------
    ser : serial.Serial() instance
        The device we are reading from.
    n_reads : int
        The number of reads up to newlines
    read_buffer : bytes, default b&#39;&#39;
        Previous read buffer that is appended to.

    Returns
    -------
    output : bytes
        Bytes object that contains read_buffer + read.

    Notes
    -----
    .. This is a drop-in replacement for read_all().
    &quot;&quot;&quot;
    raw = read_buffer
    for _ in range(n_reads):
        raw += ser.read_until()

    return raw


def parse_read(read):
    &quot;&quot;&quot;Parse a read with time, voltage data

    Parameters
    ----------
    read : byte string
        Byte string with comma delimited time/voltage
        measurements.

    Returns
    -------
    time_ms : list of ints
        Time points in milliseconds.
    voltage : list of floats
        Voltages in volts.
    remaining_bytes : byte string
        Remaining, unparsed bytes.
    &quot;&quot;&quot;
    time_ms = []
    voltage = []

    # Separate independent time/voltage measurements
    pattern = re.compile(b&quot;\d+|,&quot;)
    raw_list = [b&quot;&quot;.join(pattern.findall(raw)).decode() for raw in read.split(b&quot;\r\n&quot;)]

    for raw in raw_list[:-1]:
        try:
            t, V = raw.split(&quot;,&quot;)
            time_ms.append(int(t))
            voltage.append(int(V) * 5 / 1023)
        except:
            pass

    if len(raw_list) == 0:
        return time_ms, voltage, b&quot;&quot;
    else:
        return time_ms, voltage, raw_list[-1].encode()


def parse_raw(raw):
    &quot;&quot;&quot;Parse bytes output from Arduino.&quot;&quot;&quot;
    raw = raw.decode()
    if raw[-1] != &quot;\n&quot;:
        raise ValueError(
            &quot;Input must end with newline, otherwise message is incomplete.&quot;
        )

    t, V = raw.rstrip().split(&quot;,&quot;)

    return int(t), int(V) * 5 / 1023


def request_single_voltage(arduino):
    &quot;&quot;&quot;Ask Arduino for a single data point&quot;&quot;&quot;
    # Ask Arduino for data
    arduino.write(bytes([VOLTAGE_REQUEST]))

    # Read in the data
    raw = arduino.read_until()

    # Parse and return
    return parse_raw(raw)


def plot(mode):
    &quot;&quot;&quot;Build a plot of voltage vs time data&quot;&quot;&quot;
    # Set up plot area
    p = bokeh.plotting.figure(
        frame_width=500,
        frame_height=175,
        x_axis_label=&quot;time (s)&quot;,
        y_axis_label=&quot;voltage (V)&quot;,
        title=&quot;streaming data&quot; if mode == &quot;stream&quot; else &quot;on-demand data&quot;,
        y_range=[-0.2, 5.2],
        toolbar_location=&quot;above&quot;,
    )

    # No range padding on x: signal spans whole plot
    p.x_range.range_padding = 0

    # We&#39;ll sue whitesmoke backgrounds
    p.border_fill_color = &quot;whitesmoke&quot;

    # Defined the data source
    source = bokeh.models.ColumnDataSource(data=dict(t=[], V=[]))

    # If we are in streaming mode, use a line, dots for on-demand
    if mode == &quot;stream&quot;:
        p.line(source=source, x=&quot;t&quot;, y=&quot;V&quot;)
    else:
        p.circle(source=source, x=&quot;t&quot;, y=&quot;V&quot;)

    # Put a phantom circle so axis labels show before data arrive
    phantom_source = bokeh.models.ColumnDataSource(data=dict(t=[0], V=[0]))
    p.circle(source=phantom_source, x=&quot;t&quot;, y=&quot;V&quot;, visible=False)

    return p, source, phantom_source


def controls(mode):
    if mode == &quot;stream&quot;:
        acquire = bokeh.models.Toggle(label=&quot;stream&quot;, button_type=&quot;success&quot;, width=100)
        save_notice = bokeh.models.Div(
            text=&quot;&lt;p&gt;No streaming data saved.&lt;/p&gt;&quot;, width=165
        )
    else:
        acquire = bokeh.models.Button(label=&quot;acquire&quot;, button_type=&quot;success&quot;, width=100)
        save_notice = bokeh.models.Div(
            text=&quot;&lt;p&gt;No on-demand data saved.&lt;/p&gt;&quot;, width=165
        )

    save = bokeh.models.Button(label=&quot;save&quot;, button_type=&quot;primary&quot;, width=100)
    reset = bokeh.models.Button(label=&quot;reset&quot;, button_type=&quot;warning&quot;, width=100)
    file_input = bokeh.models.TextInput(
        title=&quot;file name&quot;, value=f&quot;{mode}.csv&quot;, width=165
    )

    return dict(
        acquire=acquire,
        reset=reset,
        save=save,
        file_input=file_input,
        save_notice=save_notice,
    )


def layout(p, ctrls):
    buttons = bokeh.layouts.row(
        bokeh.models.Spacer(width=30),
        ctrls[&quot;acquire&quot;],
        bokeh.models.Spacer(width=295),
        ctrls[&quot;reset&quot;],
    )
    left = bokeh.layouts.column(p, buttons, spacing=15)
    right = bokeh.layouts.column(
        bokeh.models.Spacer(height=50),
        ctrls[&quot;file_input&quot;],
        ctrls[&quot;save&quot;],
        ctrls[&quot;save_notice&quot;],
    )
    return bokeh.layouts.row(
        left, right, spacing=30, margin=(30, 30, 30, 30), background=&quot;whitesmoke&quot;,
    )


def acquire_callback(arduino, stream_data, source, phantom_source, rollover):
    # Pull t and V values from stream or request from Arduino
    if stream_data[&quot;mode&quot;] == &quot;stream&quot;:
        t = stream_data[&quot;t&quot;][-1]
        V = stream_data[&quot;V&quot;][-1]
    else:
        t, V = request_single_voltage(arduino)

    # Add to on-demand data dictionary
    on_demand_data[&quot;t&quot;].append(t)
    on_demand_data[&quot;V&quot;].append(V)

    # Send new data to plot
    new_data = dict(t=[t / 1000], V=[V])
    source.stream(new_data, rollover=rollover)

    # Update the phantom source to keep the x_range on plot ok
    phantom_source.data = new_data


def stream_callback(arduino, stream_data, new):
    if new:
        stream_data[&quot;mode&quot;] = &quot;stream&quot;
    else:
        stream_data[&quot;mode&quot;] = &quot;on-demand&quot;
        arduino.write(bytes([ON_REQUEST]))

    arduino.reset_input_buffer()


def reset_callback(mode, data, source, phantom_source, controls):
    # Turn off the stream
    if mode == &quot;stream&quot;:
        controls[&quot;acquire&quot;].active = False

    # Black out the data dictionaries
    data[&quot;t&quot;] = []
    data[&quot;V&quot;] = []

    # Reset the sources
    source.data = dict(t=[], V=[])
    phantom_source.data = dict(t=[0], V=[0])


def save_callback(mode, data, controls):
    # Convert data to data frame and save
    df = pd.DataFrame(data={&quot;time (ms)&quot;: data[&quot;t&quot;], &quot;voltage (V)&quot;: data[&quot;V&quot;]})
    df.to_csv(controls[&quot;file_input&quot;].value, index=False)

    # Update notice text
    notice_text = &quot;&lt;p&gt;&quot; + (&quot;Streaming&quot; if mode == &quot;stream&quot; else &quot;On-demand&quot;)
    notice_text += f&quot; data was last saved to {controls[&#39;file_input&#39;].value}.&lt;/p&gt;&quot;
    controls[&quot;save_notice&quot;].text = notice_text


def disable_controls(controls):
    &quot;&quot;&quot;Disable all controls.&quot;&quot;&quot;
    for key in controls:
        controls[key].disabled = True


def shutdown_callback(
    arduino, daq_task, stream_data, stream_controls, on_demand_controls
):
    # Disable controls
    disable_controls(stream_controls)
    disable_controls(on_demand_controls)

    # Strop streaming
    stream_data[&quot;mode&quot;] = &quot;on-demand&quot;
    arduino.write(bytes([ON_REQUEST]))

    # Stop DAQ async task
    daq_task.cancel()

    # Disconnect from Arduino
    arduino.close()


def stream_update(data, source, phantom_source, rollover):
    # Update plot by streaming in data
    new_data = {
        &quot;t&quot;: np.array(data[&quot;t&quot;][data[&quot;prev_array_length&quot;] :]) / 1000,
        &quot;V&quot;: data[&quot;V&quot;][data[&quot;prev_array_length&quot;] :],
    }
    source.stream(new_data, rollover)

    # Adjust new phantom data point if new data arrived
    if len(new_data[&quot;t&quot;] &gt; 0):
        phantom_source.data = dict(t=[new_data[&quot;t&quot;][-1]], V=[new_data[&quot;V&quot;][-1]])
    data[&quot;prev_array_length&quot;] = len(data[&quot;t&quot;])


def potentiometer_app(
    arduino, stream_data, on_demand_data, daq_task, rollover=400, stream_plot_delay=90,
):
    def _app(doc):
        # Plots
        p_stream, stream_source, stream_phantom_source = plot(&quot;stream&quot;)
        p_on_demand, on_demand_source, on_demand_phantom_source = plot(&quot;on demand&quot;)

        # Controls
        stream_controls = controls(&quot;stream&quot;)
        on_demand_controls = controls(&quot;on_demand&quot;)

        # Shut down
        shutdown_button = bokeh.models.Button(
            label=&quot;shut down&quot;, button_type=&quot;danger&quot;, width=100
        )

        # Layouts
        stream_layout = layout(p_stream, stream_controls)
        on_demand_layout = layout(p_on_demand, on_demand_controls)

        # Shut down layout
        shutdown_layout = bokeh.layouts.row(
            bokeh.models.Spacer(width=675), shutdown_button
        )

        app_layout = bokeh.layouts.column(
            stream_layout, on_demand_layout, shutdown_layout
        )

        def _acquire_callback(event=None):
            acquire_callback(
                arduino,
                stream_data,
                on_demand_source,
                on_demand_phantom_source,
                rollover,
            )

        def _stream_callback(attr, old, new):
            stream_callback(arduino, stream_data, new)

        def _stream_reset_callback(event=None):
            reset_callback(
                &quot;stream&quot;,
                stream_data,
                stream_source,
                stream_phantom_source,
                stream_controls,
            )

        def _on_demand_reset_callback(event=None):
            reset_callback(
                &quot;on demand&quot;,
                on_demand_data,
                on_demand_source,
                on_demand_phantom_source,
                on_demand_controls,
            )

        def _stream_save_callback(event=None):
            save_callback(&quot;stream&quot;, stream_data, stream_controls)

        def _on_demand_save_callback(event=None):
            save_callback(&quot;on demand&quot;, on_demand_data, on_demand_controls)

        def _shutdown_callback(event=None):
            shutdown_callback(
                arduino, daq_task, stream_data, stream_controls, on_demand_controls
            )

        @bokeh.driving.linear()
        def _stream_update(step):
            stream_update(stream_data, stream_source, stream_phantom_source, rollover)

            # Shut down server if Arduino disconnects (commented out in Jupyter notebook)
            if not arduino.is_open:
                sys.exit()

        # Link callbacks
        stream_controls[&quot;acquire&quot;].on_change(&quot;active&quot;, _stream_callback)
        stream_controls[&quot;reset&quot;].on_click(_stream_reset_callback)
        stream_controls[&quot;save&quot;].on_click(_stream_save_callback)
        on_demand_controls[&quot;acquire&quot;].on_click(_acquire_callback)
        on_demand_controls[&quot;reset&quot;].on_click(_on_demand_reset_callback)
        on_demand_controls[&quot;save&quot;].on_click(_on_demand_save_callback)
        shutdown_button.on_click(_shutdown_callback)

        # Add the layout to the app
        doc.add_root(app_layout)

        # Add a periodic callback, monitor changes in stream data
        pc = doc.add_periodic_callback(_stream_update, stream_plot_delay)

    return _app


# Set up connection
HANDSHAKE = 0
VOLTAGE_REQUEST = 1
RED_LED_ON = 2
RED_LED_OFF = 3
GREEN_LED_ON = 4
GREEN_LED_OFF = 5
ON_REQUEST = 6
STREAM = 7
READ_DAQ_DELAY = 8

# Windows users may need to give COM port for find_arduino()
port = find_arduino()

# Connect and handshake
arduino = serial.Serial(port, baudrate=115200)
handshake_arduino(arduino)

# Set up data dictionaries
stream_data = dict(prev_array_length=0, t=[], V=[], mode=&quot;on demand&quot;)
on_demand_data = dict(t=[], V=[])


async def daq_stream_async(
    arduino,
    data,
    delay=20,
    n_trash_reads=5,
    n_reads_per_chunk=4,
    reader=read_all_newlines,
):
    &quot;&quot;&quot;Obtain streaming data&quot;&quot;&quot;
    # Specify delay
    arduino.write(bytes([READ_DAQ_DELAY]) + (str(delay) + &quot;x&quot;).encode())

    # Current streaming state
    stream_on = False

    # Receive data
    read_buffer = [b&quot;&quot;]
    while True:
        if data[&quot;mode&quot;] == &quot;stream&quot;:
            # Turn on the stream if need be
            if not stream_on:
                arduino.write(bytes([STREAM]))

                # Read and throw out first few reads
                i = 0
                while i &lt; n_trash_reads:
                    _ = arduino.read_until()
                    i += 1

                stream_on = True

            # Read in chunk of data
            raw = reader(arduino, read_buffer=read_buffer[0], n_reads=n_reads_per_chunk)

            # Parse it, passing if it is gibberish
            try:
                t, V, read_buffer[0] = parse_read(raw)

                # Update data dictionary
                data[&quot;t&quot;] += t
                data[&quot;V&quot;] += V
            except:
                pass
        else:
            # Make sure stream is off
            stream_on = False

        # Sleep 80% of the time before we need to start reading chunks
        await asyncio.sleep(0.8 * n_reads_per_chunk * delay / 1000)


# Set up asynchronous DAQ task
daq_task = asyncio.create_task(daq_stream_async(arduino, stream_data))

# Build app
app = potentiometer_app(
    arduino, stream_data, on_demand_data, daq_task, rollover=400, stream_plot_delay=90
)

# Build it with curdoc
app(bokeh.plotting.curdoc())
</pre></div>
</div>
</div>
<div class="section" id="Computing-environment">
<h2>Computing environment<a class="headerlink" href="#Computing-environment" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">load_ext</span> watermark
<span class="o">%</span><span class="k">watermark</span> -v -p numpy,pandas,serial,bokeh,jupyterlab
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Python implementation: CPython
Python version       : 3.8.10
IPython version      : 7.22.0

numpy     : 1.20.2
pandas    : 1.2.4
serial    : 3.5
bokeh     : 2.3.2
jupyterlab: 3.0.14

</pre></div></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="l14_testing_and_tdd.html" class="btn btn-neutral float-right" title="Lesson 14: Testing and test-driven development" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="l41_serial_apps.html" class="btn btn-neutral float-left" title="Lesson 41. Apps for controlling external devices" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">
        Last updated on Jun 25, 2021.
      </span>

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-65442910-1', 'auto');
    
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>